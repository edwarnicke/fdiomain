<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1">









<title>Building Network Service Mesh</title>

<meta name="generator" content="Hugo 0.49" />

<meta name="hugo.type" content="tasks">

















<link rel="stylesheet"
      href="/fdiomain/bundle.min.8bf4c191efae4f27c4bc627263b1c8e140e8344383f894b4a143ce7774009f9b.css"
      integrity="sha256-i/TBke&#43;uTyfEvGJyY7HI4UDoNEOD&#43;JS0oUPOd3QAn5s=">












<script defer src="/fdiomain/bundle.min.3e87135058cd0f4e4db4987f5162be5af4aec75afd881b94a2f454f4bede4367.js"
        integrity="sha256-PocTUFjND05NtJh/UWK&#43;WvSux1r9iBuUovRU9L7eQ2c="></script>


</head>
<body>

    
<header>
<div class="container-fluid">
  <div class="row-fluid">
    <div class="col-md-1">
        <a class="navbar-brand" href="/">
            <img class="img-responsive" src="https://jadenisco.github.io/fdiomainimg/logo_fdio_header.png" alt="FDio - The Universal Dataplane Logo">
        </a>
    </div>
    <div class="col-md-10 fix-navbar-zindex">
      
      <nav class="navbar navbar-default">
        <div class="container-fluid">
          
          <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
          </div>
            
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
              <ul class="nav navbar-nav navbar-right">
              
                <li><a href="https://gerrit.fd.io/">GERRIT</a></li>
              
                <li><a href="/fdiomain/docs/">DOCUMENTATION</a></li>
              
                <li><a href="/fdiomain/community/">COMMUNITY</a></li>
              
                <li><a href="/fdiomain/events/">EVENTS</a></li>
              
                <li><div id="qrcode"></div></li>
              </ul>
            </div>
          </div>
        </nav>
      </div>
    </div>
  </div>
</header>
<div id="qrbig"></div>

    
<section id="docs-header">
    <div class="container">
        <div class="row">
            <div class="col-md-2"></div>
            <div class="col-md-2"><a href="/docs/concepts/">CONCEPTS</a></div>
            <div class="col-md-2"><a href="/docs/setup/">SETUP</a></div>
            <div class="col-md-2"><a href="/docs/tasks/">TASKS</a></div>
            <div class="col-md-2"><a href="/docs/videos/">VIDEOS</a></div>
            <div class="col-md-2"></div>
        </div>
    </div>
</section>
    
    <section>
        <div class="container">
            <div class="row">
            <div class="col-md-12">
                
                <img src="https://jadenisco.github.io/img/tasks/build.jpg" class="img-responsive" alt="post-thumb"> 
                <div class="block markdown-body">
                <h1 id="prerequisites-to-build">Prerequisites to Build</h1>

<p>You will need to install</p>

<ol>
<li>golang - <a href="https://golang.org/dl/">recommend version 1.11</a></li>
<li>protobuf</li>
<li>dep</li>
<li>shellcheck - only used for <code>make check</code></li>
<li><a href="https://docs.docker.com/install/">Docker</a> - for building containers</li>
<li><a href="https://www.vagrantup.com/docs/installation/">Vagrant</a> - if you want to use the supplied two nodes K8s cluster for testing</li>
</ol>

<h2 id="on-a-mac">On a Mac:</h2>

<pre><code class="language-bash">brew install dep golang protobuf shellcheck
</code></pre>

<h1 id="building">Building</h1>

<p>All of the actual code in Network Service Mesh builds as pure go:</p>

<pre><code class="language-bash">go generate ./...
go build ./...
</code></pre>

<p>But to really do interesting things in NSM, you will want to build various Docker containers, and deploy them to K8s.
All of this is doable via normal Docker/K8s commands, but to speed development, some make machinery has been added to make things easy.</p>

<h2 id="building-and-saving-container-images-using-the-make-machinery">Building and Saving container images using the Make Machinery</h2>

<p>You can build all of the containers needed for NSM, including a bunch of handle Network Service Endpoints (NSEs) and NSCs (Network Service Clients) that are useful for testing, but not part of the core with:</p>

<pre><code>make k8s-build
</code></pre>

<p>If you are using the vagrant machinery to run your K8s cluster (described a bit further down), you really want to use:</p>

<pre><code>make k8s-save
</code></pre>

<p>instead of</p>

<pre><code>make k8s-build
</code></pre>

<p>because <code>make k8s-save</code> will build your containers and save them in scripts/vagrant/images where they can be loaded by the vagrant K8s cluster.</p>

<p>You can also selectively rebuild any component, say the nsmd, with:</p>

<pre><code>make k8s-nsmd-save
</code></pre>

<h1 id="running-the-nsm-code">Running the NSM code</h1>

<p>Network Service Mesh provides a handy vagrant setup for running a two node K8s cluster.  Once you&rsquo;ve done <code>make k8s-save</code>, you can deploy to it with:</p>

<pre><code>make k8s-deploy
</code></pre>

<p>By default this will:
1. Spin up a two node K8s cluster from scripts/vagrant if one is not already running.
2. Delete old instances of NSM config if present
3. Load all images from scripts/vagrant/images into the master and worker node
2. Deploy the nsmd and vppagent-dataplane Daemonsets
3. Deploy a variety of Network Service Endpoints and Network Service Clients
4. Deploy the crossconnect-monitor (a useful tool for debugging)</p>

<p>You can check to see things working by typing:</p>

<pre><code>make k8s-check
</code></pre>

<p>which will try pinging from NSCs to NSEs.</p>

<p>You can remove the effects of k8s-deploy with:</p>

<pre><code>make k8s-delete
</code></pre>

<p>As in the case with save and build, you can always do this for a particular component, like <code>make k8s-nsc-deploy</code> or <code>make k8s-nsc-delete</code>.</p>

<h2 id="having-more-control-over-the-deployment">Having more control over the deployment</h2>

<p>The described quick start method works for fast deployments and quick tests. However, the build infrastructure provides a fine-grained control over the deployments.</p>

<h3 id="working-with-the-vagrant-setup">Working with the vagrant setup</h3>

<p>To spin the default 2 node vagrant setup with Kubernetes on top type:</p>

<pre><code>make vagrant-start
</code></pre>

<p>At any point, you can <code>make vagrant-suspend</code> and <code>make vagrant-resume</code> to pause and restore the spawn virtual nodes. If for some you need to rebuild or completely destroy the vagrant environment, use <code>make vagrant-restart</code> and <code>make vagrant-destroy</code></p>

<p>To point your <code>kubectl</code> to the Kubernetes deployment in the virtual nodes, use:</p>

<pre><code>source scripts/vagrant/env.sh
</code></pre>

<h3 id="deploying-the-nsm-infrastructure">Deploying the NSM infrastructure</h3>

<p>Network Service Mesh consists of a number of system pods, which take care of service registration, provide the dataplane functionality, do monitoring and observability. Once you have configured your <code>kubectl</code> to the desired Kubernets master (may or may not be set through vagrant), you can initiate the NSM infrastructure deployment and deletion using <code>make k8s-infra-deploy</code> and <code>make k8s-infra-delete</code>.</p>

<h3 id="deploying-the-icmp-example-and-testing-it">Deploying the ICMP example and testing it</h3>

<p>The project comes with a simple, ready to test ICMP example. It deploys a number of ICMP responder NSEs and connects NSCs to them. This shows same and cross-node communication and is good for visualising it with the provided monitoring tools.
The commands to deploy and delete it are <code>make k8s-icmp-deploy</code> and <code>make k8s-icmp-delete</code>. Checking the operability of the ICMP example is done through <code>make k8s-check</code></p>

<h3 id="deploying-the-vpn-composed-network-service">Deploying the VPN composed Network Service</h3>

<p>One of the big advantages on Network Service Mesh is NS composition, i.e. forming a complex service out of a number of simple NSEs. The project comes with an example that implements the &ldquo;secure-intranet-connectivity&rdquo; Network Service which connects together a simple ACL based packet filtering firewall and a simulated VPN gateway NSEs. Deploying it is done through <code>make k8s-vpn-deploy</code> and to uninstall it run <code>make k8s-vpn-delete</code>. Checking VPN&rsquo;s operability is done with <code>make k8s-check</code>.</p>

<h1 id="helpful-logging-tools">Helpful Logging tools</h1>

<p>In the course of developing NSM, you will often find yourself wanting to look at logs for various nsm components.</p>

<pre><code>make k8s-nsmd-logs
</code></pre>

<p>will dump all the logs for all running nsmd Pods in the cluster (you are going to want to redirect these to a file).
This works for any component in the system.</p>

<p>Of particular utility:</p>

<pre><code>make k8s-crossconnect-monitor-logs
</code></pre>

<p>dumps the logs from the crossconnect-monitor, which has been logging new crossconnects as they come into existence and go away throughout
the cluster.</p>

<h1 id="regenerating-code">Regenerating code</h1>

<p>If you change <a href="https://github.com/networkservicemesh/networkservicemesh/blob/master/k8s/pkg/apis/networkservice/v1/types.go">types.go</a> or any of the .proto files you will need to be able to run <code>go generate ./...</code> to regenerate the code.</p>

<p>In order to be able to do that you need to have installed:</p>

<ul>
<li>protobuf - run <code>./scripts/install-protoc.sh</code></li>
<li>proto-gen-go - run <code>go install ./vendor/github.com/golang/protobuf/protoc-gen-go/</code></li>
<li>deep-copy-gen - run <code>go install ./vendor/k8s.io/code-generator/cmd/deepcopy-gen/</code></li>
</ul>

<p>Then just run:</p>

<pre><code>go generate ./...
</code></pre>

<h1 id="updating-deps">Updating Deps</h1>

<p>If you need to add new dependencies to the vendor/ directory.
1.  <a href="https://golang.github.io/dep/docs/installation.html">Install dep</a>
2.  Run <code>dep ensure</code></p>

<h1 id="shellcheck">Shellcheck</h1>

<p>As part of our CI, we run shellcheck on all shell scripts in the repo.
If you want to run it locally, you need to:</p>

<ol>
<li><a href="https://github.com/koalaman/shellcheck#installing">Install shellcheck</a></li>
</ol>

<h1 id="canonical-source-on-how-to-build">Canonical source on how to build</h1>

<p>The <a href="https://github.com/networkservicemesh/networkservicemesh/blob/master/.circleci/config.yml">.circleci/config.yml</a> file is the canonical source of how to build Network Service Mesh in case this file becomes out of date.</p>

                </div>
            </div>
            </div>
        </div>
    </section>

	
<footer>
  <div class="container">
    <div class="row">
      <div class="col-md-12">
        <div class="footer-manu">
          <ul>
            
          </ul>
        </div>
        <p><a href="https://themes.gohugo.io/airspace-hugo/">Airspace Hugo Theme</a> Copyright &copy; Design &amp; Developed by <a href="https://themefisher.com/">Themefisher</a>. <a href="https://themefisher.com/license/">Creative Commons Attribution 3.0 License.</a></p>
      </div>
    </div>
  </div>
</footer>


	
</body>
</html>
